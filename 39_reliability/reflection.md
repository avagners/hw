# Формализуем понятие надёжности системы

## Ключевые свойства Apache Airflow
5 ключевых свойств для анализа надёжности системы:

| Свойство                                   | Узкий диапазон | Широкий диапазон |
|--------------------------------------------|---------------|------------------|
| **Время выполнения задачи**                | 5-15 минут    | 1-60 минут      |
| **Количество одновременно запущенных DAGs** | 10-20 DAGs    | 1-50 DAGs       |
| **Время появления DAG в списке после деплоя** | 30-60 секунд | 1-300 секунд    |
| **Задержка в обработке задач**             | < 5 секунд    | < 30 секунд     |
| **Доступность Web UI**                      | 99.9%         | 95%             |

## Определение инвариантов
### 1. Время выполнения задачи
Инвариант: STABLE(1-60 мин)

Диапазон: задачи могут временно выходить за узкие границы (5-15 мин), но в среднем должны оставаться в широком диапазоне (1-60 мин).

Усиление: можно стремиться к RESILIENT(5-15 мин), оптимизируя ресурсы для выполнения задач.

### 2. Количество одновременно запущенных DAGs
Инвариант: RESILIENT(1-50 DAGs)

Диапазон: даже при пиковых нагрузках система должна возвращаться к контролируемому количеству DAGs.

Усиление: можно добавить ограничение на число DAGs или выделить динамические ресурсы.

### 3. Время появления DAG в списке после деплоя
Инвариант: TRIPWIRE(1-300 сек)

Диапазон: может быть случайная задержка при первом появлении DAG, но после попадания в список оно должно оставаться под контролем.

Усиление: можно снизить разброс задержек, оптимизируя dagbag_refresh_interval.

### 4. Задержка в обработке задач
Инвариант: STABLE(широкий < 30 сек)

Диапазон: разовые всплески задержек допустимы, но в среднем система должна работать стабильно.

Усиление: стремление к STABLE(узкий < 5 сек) с балансировкой нагрузки.

### 5. Доступность Web UI
Инвариант: STRONG(99.9%)

Диапазон: любое отклонение — ошибка.

Усиление: использование репликации и отказоустойчивых механизмов.

## Усиление инвариантов
Наиболее перспективные направления:

- Сокращение задержек (DAG-ов и задач) → Тюнинг Scheduler и базы данных.
- Балансировка нагрузки → Оптимизация количества воркеров.
- Устойчивость Web UI → Репликация и отказоустойчивость.

## Добавление характеристики скорости восстановления
Можно ввести метрику "время восстановления":

- Время восстановления Web UI после падения.
- Время восстановления задержек обработки DAGs.
- Время восстановления после перегрузки воркеров.

Это позволит задать граничные сроки восстановления и сделать систему более предсказуемой.

---
## Выводы

Мой опыт из прошлого приучил меня отслеживать метрики для достижения поставленных целей. Это касается не только в разработке/поддержке ПО, но и просто каких-то бизнес-процессов.
Так я давно уже понял, что если мы не выделили ключевые метрики и с ними не работаем на ежедневной основе, то достич целей никак нельзя. 

Подход с инвариантами STRONG, TRIPWIRE, STABLE, RESILIENT, WEAK как раз про это.

После изучения материала я пришел к следующим выводам:

1) Надёжность — это не абсолютная характеристика, а балансируемый набор свойств

    - Разные системы требуют разных уровней контроля: где-то нужна жёсткая гарантия (STRONG), а где-то достаточно просто уметь восстанавливаться (RESILIENT).

    - Нельзя сделать систему абсолютно надёжной — всегда есть компромисс между жёсткими ограничениями и гибкостью.

2) Инварианты помогают формально описать устойчивость системы

    - Теперь понятно, что задержки, время отклика, доступность — это не просто числа, а инженерные характеристики, которые можно формализовать.

    - Например, можно заявить, что "наше время выполнения задач STABLE(1-60 мин)" и это сразу задаёт границы ожиданий.

3) Не все сбои можно предотвратить, но можно управлять их последствиями

    - Важно не только поддерживать систему в рабочем состоянии, но и понимать, как она должна восстанавливаться после сбоев.

    - Инвариант RESILIENT даёт понимание, что "да, сбои неизбежны, но система всегда должна уметь вернуться в норму".

4) Можно работать над улучшением свойств системы, а не только "гасить пожары"

    - Надёжность можно усилить оптимизацией, масштабированием, отказоустойчивостью.

    - Например, если Web UI Airflow сейчас держит STRONG(99.9%), но иногда падает, можно добиться HA-конфигурации и поднять его до реального 99.99%.

5) Скорость восстановления — важная, но сложная метрика

    - В реальности недостаточно просто знать, что система восстановится, важно понимать, через сколько секунд, минут или часов.

    - Внедрение таймингов для восстановления позволяет ставить конкретные SLA и контролировать поведение системы в критических ситуациях.

После этого задания начинаешь смотреть на системы по-другому: не просто "работает или не работает", а какие у неё границы устойчивости, как она ведёт себя в сбоях и как её можно улучшить.