# Зависимости от зависимостей

## 1. Зависимость фреймворка

Apache Airflow используется для планирования ETL-задач. Я думал, что мои DAGs (графы задач) зависят только от самих задач и не должны оказывать какого-то негативного влияния на весь Airflow. Но как оказалось Airflow довольно чувствителен к некоторым ошибкам в DAGs, что приводило к краху всего Airflow. То есть один "невалидный" DAG ломает весь Airflow, на котором крутится тысичи DAGs. Например, мог зависнуть шедулер из-за чего не стартовали таски по расписани во всех DAGs.

Решение: валидация DAGs на известные ошибки в CI/CD.

## 2. Зависимость расшаренного формата  

Я разрабатывал пайплайн для загрузки данных из CSV-файлов в базу данных. Один из отделов генерировал файлы, а моя задача была их обработать. В какой-то момент они изменили формат CSV (добавили новый столбец), что привело к сбоям в моём пайплайне.   

Решение: добавил валидацию формата входящих файлов перед загрузкой данных и начал отслеживать изменения формата. Решение было интуитивным, но потом я осознал важность строгого контроля над зависимостью форматов.

## 3. Зависимость зависимости

Один раз я пытался избавиться от зависимости от одной сторонней библиотеки для подключения к API внешней системы. Убрал вызовы этой библиотеки и заменил на свою реализацию через стандартные библиотеки Python. Позже обнаружил, что одна из внутренних библиотек, которую я использовал, сама полагалась на ту же библиотеку, от которой я пытался избавиться.  

Решение: полностью отказаться от библиотеки не получилось. Этот пример показал, что даже если я устраняю явную зависимость в своём коде, другие библиотеки могут её подтягивать через собственные зависимости.

## 4. Зависимость краша

В одном из пайплайнов обработки данных я использовал Spark для распределенной обработки. Случайно изменил настройки памяти для одного компонента, что привело к краху других частей пайплайна, хотя они напрямую от этого не зависели.  

Решение: После этого я начал тщательнее следить за конфигурацией spark-приложений.

## 5. Зависимость перебрасывания

Мы использовали S3 для хранения больших данных, но на случай сбоя у нас было резервное локальное хранилище. Если облачное хранилище становилось недоступным, данные сохранялись на локальный сервер.  

Решение: этот сценарий был заранее предусмотрен, так как система должна была быть устойчивой к сбоям.

## 6. Зависимость инверсии

Не смог вспомнить или подобрать должный пример из практики. Кажется, мне не попадалось задач связанных с DI. А отдельно я данную тему еще не изучал.

## 7. Зависимость зацикливания

Модуль загрузки данных из базы данных зависел от данных, обрабатываемых в модуле агрегации, чтобы обеспечить полную и актуальную информацию. Однако в то же время модуль агрегации также требовал наличия данных, уже загруженных в базу. Это создало зацикливание: модуль A (загрузка данных) зависел от модуля B (агрегация), а модуль B зависел от модуля A. При попытке запустить процесс ETL я столкнулся с проблемами: модули не могли завершить свою работу, так как каждый из них ждал, когда другой модуль выполнит свою часть.  

Решение: добавили хранение промежуточных результатов, которое позволило сохранять данные после первой загрузки и выполнять агрегацию на основе этих сохранённых данных.


## 8. Зависимость высшего порядка

В проекте по обработке данных я использовал библиотеку `Pandas` для агрегации данных. Я создал пользовательский класс с переопределённым методом сравнения `__eq__` для работы с кастомными объектами. При попытке использовать `Pandas` для объединения таблиц через `merge()` результат был неверным, так как метод `__eq__` возвращал некорректные значения.

Решение: исправил метод `__eq__`, чтобы корректно сравнивать объекты, и `Pandas` начал работать как ожидается.


## 9. Зависимость большинства

В `Hadoop` несколько задач `MapReduce` выполняются на разных нодах кластера.
Если хотя бы на одной из нод возникала ошибка в обработке данных, вся задача завершалась неудачно, даже если большинство нод выполнили свои части без проблем.

Решение: внедрили механизм повторного запуска задач на нодах, где произошёл сбой.


## Выводы

Для меня данная тема оказалась новой. Я практически никогда не задумывался о зависимостях. Максимум что мне попадалось это несовместопость версий в библиотеках. 
После рассмотрения всех 9 типов зависимостей, я понял, что работа с зависимостями — это гораздо сложнее, чем просто избегать лишних библиотек или абстрагироваться от них.

Зависимости не всегда очевидны. Даже если кажется, что один модуль независим от другого, на практике они могут косвенно влиять друг на друга.
Проектирование с учётом зависимостей с самого начала — это очень важно. Правильные абстракции могут спасти много времени и усилий в будущем.
Нужны обязательно тесты и мониторинг. Без них сложно предсказать, как изменения в одном месте могут повлиять на другую часть системы.
Даже малый сбой может сломать всю обработку. Высший порядок зависимостей заставляет быть внимательным к деталям в собственных классах и методах, так как они могут сломать работу внешних библиотек.
